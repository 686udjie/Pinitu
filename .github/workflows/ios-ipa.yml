name: iOS IPA

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-ipa:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Restore packages
        run: flutter pub get

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS (no codesign)
        run: |
          flutter build ios --release --no-codesign

      - name: Install zsign
        run: |
          brew update
          brew install zsign

      - name: Prepare signing materials
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p signing
          if [ -z "${IOS_P12_BASE64:-}" ]; then echo "Missing secret IOS_P12_BASE64" >&2; exit 1; fi
          if [ -z "${IOS_MOBILEPROVISION_BASE64:-}" ]; then echo "Missing secret IOS_MOBILEPROVISION_BASE64" >&2; exit 1; fi
          echo "$IOS_P12_BASE64" | base64 --decode > signing/cert.p12
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > signing/app.mobileprovision
          ls -lah signing

      - name: Resign and package .ipa with zsign
        env:
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          set -euo pipefail
          APP_PATH="build/ios/iphoneos/Runner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Runner.app not found at $APP_PATH" >&2
            echo "Check flutter build logs for errors." >&2
            exit 1
          fi
          echo "zsign version:"
          zsign -v || true

          ZSIGN_ARGS=(
            -k signing/cert.p12
            -p "$IOS_P12_PASSWORD"
            -m signing/app.mobileprovision
          )

          if [ -n "${IOS_BUNDLE_ID:-}" ]; then
            echo "Overriding bundle identifier to $IOS_BUNDLE_ID"
            ZSIGN_ARGS+=( -b "$IOS_BUNDLE_ID" )
          fi

          echo "Signing and packaging IPA..."
          zsign "${ZSIGN_ARGS[@]}" -o Pinitu-ios.ipa "$APP_PATH"
          echo "IPA created: $(pwd)/Pinitu-ios.ipa"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pinitu-ipa
          path: Pinitu-signed.ipa
          if-no-files-found: error